<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人分析 - ROK Kingdom Data</title>
    <link rel="stylesheet" href="styles/common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="back-nav" style="margin-bottom: 20px;">
            <a href="index.html" style="display: inline-block; padding: 10px 20px; background: #3498db; color: white; text-decoration: none; border-radius: 8px;">← メインメニューに戻る</a>
        </div>

        <h1>👤 個人分析</h1>
        <div class="subtitle">特定プレイヤーの詳細分析とグラフ</div>
        
        <div class="filter-section">
            <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">プレイヤー検索:</label>
                    <input type="text" id="playerSearch" placeholder="プレイヤー名またはIDで検索" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; width: 250px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">プレイヤー選択:</label>
                    <select id="playerSelect" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; width: 200px;">
                        <option value="">プレイヤーを選択</option>
                    </select>
                </div>
                <button onclick="analyzePlayer()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer;">分析開始</button>
            </div>
        </div>

        <div id="analysisResult" style="display: none;">
            <div class="player-info" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h2 id="playerName">プレイヤー名</h2>
                <p>同盟: <span id="playerAlliance">-</span> | 最新パワー: <span id="playerPower">-</span></p>
            </div>

            <div class="chart-container" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                <h3>パワー推移</h3>
                <canvas id="playerChart" style="height: 400px;"></canvas>
            </div>

            <div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="stat-card">
                    <h3>総成長</h3>
                    <p id="totalGrowth">-</p>
                </div>
                <div class="stat-card">
                    <h3>平均成長率</h3>
                    <p id="avgGrowthRate">-</p>
                </div>
                <div class="stat-card">
                    <h3>データポイント数</h3>
                    <p id="dataPoints">-</p>
                </div>
            </div>
        </div>

        <div id="noData" style="text-align: center; color: #7f8c8d; margin-top: 50px;">
            プレイヤーを選択して分析を開始してください
        </div>
    </div>

    <script>
        let gameData = [];
        let playerChart = null;

        async function loadData() {
            try {
                const response = await fetch('Master_Data.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim());
                
                gameData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 4) {
                        gameData.push({
                            date: values[0],
                            id: values[1],
                            name: values[2],
                            power: parseNumber(values[3]),
                            alliance: values[4] || ''
                        });
                    }
                }
                
                updatePlayerList();
            } catch (error) {
                console.error('データ読み込みエラー:', error);
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(item => item.replace(/"/g, ''));
        }

        function parseNumber(str) {
            if (!str || str === '') return 0;
            return parseInt(str.replace(/,/g, '')) || 0;
        }

        function updatePlayerList() {
            const playerSelect = document.getElementById('playerSelect');
            const players = [...new Set(gameData.map(d => d.name))].sort();
            
            playerSelect.innerHTML = '<option value="">プレイヤーを選択</option>';
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                playerSelect.appendChild(option);
            });
        }

        function analyzePlayer() {
            const selectedPlayer = document.getElementById('playerSelect').value;
            if (!selectedPlayer) return;

            const playerData = gameData.filter(d => d.name === selectedPlayer)
                                     .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (playerData.length === 0) return;

            const latestData = playerData[playerData.length - 1];
            
            document.getElementById('playerName').textContent = selectedPlayer;
            document.getElementById('playerAlliance').textContent = latestData.alliance;
            document.getElementById('playerPower').textContent = latestData.power.toLocaleString();
            
            const totalGrowth = playerData[playerData.length - 1].power - playerData[0].power;
            const avgGrowthRate = playerData.length > 1 ? 
                ((totalGrowth / playerData[0].power) * 100 / playerData.length) : 0;
            
            document.getElementById('totalGrowth').textContent = totalGrowth.toLocaleString();
            document.getElementById('avgGrowthRate').textContent = avgGrowthRate.toFixed(2) + '%';
            document.getElementById('dataPoints').textContent = playerData.length;
            
            createPlayerChart(playerData);
            
            document.getElementById('analysisResult').style.display = 'block';
            document.getElementById('noData').style.display = 'none';
        }

        function createPlayerChart(data) {
            const ctx = document.getElementById('playerChart').getContext('2d');
            
            if (playerChart) playerChart.destroy();
            
            playerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'パワー',
                        data: data.map(d => d.power),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'パワー' }
                        }
                    }
                }
            });
        }

        document.getElementById('playerSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const playerSelect = document.getElementById('playerSelect');
            
            Array.from(playerSelect.options).forEach(option => {
                if (option.value === '') return;
                option.style.display = option.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>