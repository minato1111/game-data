<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ - ROK Kingdom Data</title>
    <meta name="description" content="Rise of Kingdoms ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸€è¦§">
    <link rel="stylesheet" href="styles/common.css">
    <style>
        .back-nav {
            margin-bottom: 20px;
        }

        .back-nav a {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-nav a:hover {
            background: #2980b9;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .sort-arrow {
            font-size: 12px;
            margin-left: 5px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #2980b9;
        }

        .pagination button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        #pageInfo {
            font-weight: 600;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .stats-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-nav">
            <a href="index.html">â† ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>

        <h1>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h1>
        <div class="subtitle">å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºãƒ»æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</div>
        
        <div class="controls">
            <div class="control-group">
                <label for="searchInput">æ¤œç´¢:</label>
                <input type="text" id="searchInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¾ãŸã¯IDã§æ¤œç´¢" oninput="searchData()">
            </div>
            <div class="control-group">
                <label for="powerFilter">ãƒ‘ãƒ¯ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                <select id="powerFilter" onchange="filterData()">
                    <option value="">å…¨ã¦</option>
                    <option value="100000000">100Mä»¥ä¸Š</option>
                    <option value="90000000">90Mä»¥ä¸Š</option>
                    <option value="80000000">80Mä»¥ä¸Š</option>
                    <option value="70000000">70Mä»¥ä¸Š</option>
                    <option value="60000000">60Mä»¥ä¸Š</option>
                    <option value="50000000">50Mä»¥ä¸Š</option>
                </select>
            </div>
            <div class="control-group">
                <label for="allianceFilter">åŒç›Ÿãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                <select id="allianceFilter" onchange="filterData()">
                    <option value="">å…¨ã¦</option>
                </select>
            </div>
            <div class="control-group">
                <label for="pageSize">è¡¨ç¤ºä»¶æ•°:</label>
                <select id="pageSize" onchange="updatePageSize()">
                    <option value="50">50ä»¶</option>
                    <option value="100" selected>100ä»¶</option>
                    <option value="200">200ä»¶</option>
                    <option value="500">500ä»¶</option>
                </select>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-item">
                <span class="stat-label">ç·ãƒ‡ãƒ¼ã‚¿æ•°</span>
                <span id="totalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">è¡¨ç¤ºä¸­</span>
                <span id="displayCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å¹³å‡ãƒ‘ãƒ¯ãƒ¼</span>
                <span id="avgPower">0</span>
            </div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">é †ä½<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(1)">ID<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(2)">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(3)">ãƒ‘ãƒ¯ãƒ¼<span class="sort-arrow">â†“</span></th>
                        <th onclick="sortTable(4)">åŒç›Ÿ<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(5)">T4ã‚­ãƒ«<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(6)">T5ã‚­ãƒ«<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(7)">ç·ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(8)">æ­»äº¡å…µå£«<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(9)">å…µå£«ãƒ‘ãƒ¯ãƒ¼<span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="10" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination">
            <button id="prevBtn" onclick="changePage(-1)" disabled>â† å‰ã¸</button>
            <span id="pageInfo">1 / 1</span>
            <button id="nextBtn" onclick="changePage(1)" disabled>æ¬¡ã¸ â†’</button>
        </div>
    </div>

    <script>
        let gameData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 100;
        let sortColumn = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ‘ãƒ¯ãƒ¼ã§ã‚½ãƒ¼ãƒˆ
        let sortDirection = -1; // é™é †

        // CSVèª­ã¿è¾¼ã¿å‡¦ç†
        async function loadData() {
            try {
                const response = await fetch('Master_Data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length === 0) {
                    throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
                }
                
                gameData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 10) {
                        gameData.push({
                            date: values[0],
                            id: values[1],
                            name: values[2],
                            power: parseNumber(values[3]),
                            alliance: values[4],
                            t4Kills: parseNumber(values[5]),
                            t5Kills: parseNumber(values[6]),
                            totalKillPoints: parseNumber(values[7]),
                            deadTroops: parseNumber(values[8]),
                            troopsPower: parseNumber(values[9])
                        });
                    }
                }
                
                // åŒç›Ÿãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é¸æŠè‚¢ã‚’æ›´æ–°
                updateAllianceFilter();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                filteredData = [...gameData];
                sortData();
                displayData();
                updateStats();
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="error-message">
                            ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // CSVè¡Œã®ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒã‚’å«ã‚€æ•°å€¤ã«å¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(item => item.replace(/"/g, ''));
        }

        // æ•°å€¤ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«å¯¾å¿œï¼‰
        function parseNumber(str) {
            if (!str || str === '') return 0;
            return parseInt(str.replace(/,/g, '')) || 0;
        }

        // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
        function formatNumber(num) {
            return num.toLocaleString();
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå‡¦ç†
        function displayData() {
            const tableBody = document.getElementById('tableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="no-data">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                updatePagination();
                return;
            }
            
            tableBody.innerHTML = '';
            
            pageData.forEach((player, index) => {
                const row = document.createElement('tr');
                const rank = startIndex + index + 1;
                
                row.innerHTML = `
                    <td>${rank}</td>
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${formatNumber(player.power)}</td>
                    <td><span class="alliance-badge">${player.alliance}</span></td>
                    <td>${formatNumber(player.t4Kills)}</td>
                    <td>${formatNumber(player.t5Kills)}</td>
                    <td>${formatNumber(player.totalKillPoints)}</td>
                    <td>${formatNumber(player.deadTroops)}</td>
                    <td>${formatNumber(player.troopsPower)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            updatePagination();
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            const totalCount = gameData.length;
            const displayCount = filteredData.length;
            
            let avgPower = 0;
            if (filteredData.length > 0) {
                avgPower = filteredData.reduce((sum, player) => sum + player.power, 0) / filteredData.length;
            }
            
            document.getElementById('totalCount').textContent = formatNumber(totalCount);
            document.getElementById('displayCount').textContent = formatNumber(displayCount);
            document.getElementById('avgPower').textContent = formatNumber(Math.round(avgPower));
        }

        // æ¤œç´¢æ©Ÿèƒ½
        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...gameData];
            } else {
                filteredData = gameData.filter(player => 
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.id.toString().includes(searchTerm)
                );
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            applyFilters();
            
            currentPage = 1;
            sortData();
            displayData();
            updateStats();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
        function filterData() {
            const powerFilter = parseInt(document.getElementById('powerFilter').value) || 0;
            const allianceFilter = document.getElementById('allianceFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = gameData.filter(player => {
                const matchesSearch = searchTerm === '' || 
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.id.toString().includes(searchTerm);
                const matchesPower = powerFilter === 0 || player.power >= powerFilter;
                const matchesAlliance = allianceFilter === '' || player.alliance === allianceFilter;
                
                return matchesSearch && matchesPower && matchesAlliance;
            });
            
            currentPage = 1;
            sortData();
            displayData();
            updateStats();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é©ç”¨
        function applyFilters() {
            const powerFilter = parseInt(document.getElementById('powerFilter').value) || 0;
            const allianceFilter = document.getElementById('allianceFilter').value;
            
            if (powerFilter > 0) {
                filteredData = filteredData.filter(player => player.power >= powerFilter);
            }
            
            if (allianceFilter !== '') {
                filteredData = filteredData.filter(player => player.alliance === allianceFilter);
            }
        }

        // åŒç›Ÿãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateAllianceFilter() {
            const allianceSelect = document.getElementById('allianceFilter');
            const alliances = [...new Set(gameData.map(player => player.alliance))].sort();
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆã€Œå…¨ã¦ã€ã¯æ®‹ã™ï¼‰
            allianceSelect.innerHTML = '<option value="">å…¨ã¦</option>';
            
            alliances.forEach(alliance => {
                if (alliance && alliance.trim()) {
                    const option = document.createElement('option');
                    option.value = alliance;
                    option.textContent = alliance;
                    allianceSelect.appendChild(option);
                }
            });
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection *= -1;
            } else {
                sortColumn = columnIndex;
                sortDirection = -1;
            }
            
            sortData();
            displayData();
            updateSortArrows();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆ
        function sortData() {
            const columnMap = {
                0: 'power', // é †ä½ï¼ˆãƒ‘ãƒ¯ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰
                1: 'id',
                2: 'name',
                3: 'power',
                4: 'alliance',
                5: 't4Kills',
                6: 't5Kills',
                7: 'totalKillPoints',
                8: 'deadTroops',
                9: 'troopsPower'
            };
            
            const sortKey = columnMap[sortColumn];
            
            filteredData.sort((a, b) => {
                let valueA = a[sortKey];
                let valueB = b[sortKey];
                
                // æ–‡å­—åˆ—ã®å ´åˆ
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    return sortDirection * valueA.localeCompare(valueB);
                }
                
                // æ•°å€¤ã®å ´åˆ
                return sortDirection * (valueA - valueB);
            });
        }

        // ã‚½ãƒ¼ãƒˆçŸ¢å°ã®æ›´æ–°
        function updateSortArrows() {
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '';
            });
            
            const currentArrow = document.querySelectorAll('.sort-arrow')[sortColumn];
            if (currentArrow) {
                currentArrow.textContent = sortDirection === 1 ? 'â†‘' : 'â†“';
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayData();
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±æ›´æ–°
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºæ›´æ–°
        function updatePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            displayData();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>