<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ一覧 - ROK Kingdom Data</title>
    <meta name="description" content="Rise of Kingdoms プレイヤーデータ一覧">
    <link rel="stylesheet" href="styles/common.css">
    <style>
        .back-nav {
            margin-bottom: 20px;
        }

        .back-nav a {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-nav a:hover {
            background: #2980b9;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .sort-arrow {
            font-size: 12px;
            margin-left: 5px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #2980b9;
        }

        .pagination button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        #pageInfo {
            font-weight: 600;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .stats-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-nav">
            <a href="index.html">← メインメニューに戻る</a>
        </div>

        <h1>📊 データ一覧</h1>
        <div class="subtitle">全プレイヤーのデータを表示・検索・フィルタリング</div>
        
        <div class="controls">
            <div class="control-group">
                <label for="searchInput">検索:</label>
                <input type="text" id="searchInput" placeholder="プレイヤー名またはIDで検索" oninput="searchData()">
            </div>
            <div class="control-group">
                <label for="powerFilter">パワーフィルター:</label>
                <select id="powerFilter" onchange="filterData()">
                    <option value="">全て</option>
                    <option value="100000000">100M以上</option>
                    <option value="90000000">90M以上</option>
                    <option value="80000000">80M以上</option>
                    <option value="70000000">70M以上</option>
                    <option value="60000000">60M以上</option>
                    <option value="50000000">50M以上</option>
                </select>
            </div>
            <div class="control-group">
                <label for="allianceFilter">同盟フィルター:</label>
                <select id="allianceFilter" onchange="filterData()">
                    <option value="">全て</option>
                </select>
            </div>
            <div class="control-group">
                <label for="pageSize">表示件数:</label>
                <select id="pageSize" onchange="updatePageSize()">
                    <option value="50">50件</option>
                    <option value="100" selected>100件</option>
                    <option value="200">200件</option>
                    <option value="500">500件</option>
                </select>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-item">
                <span class="stat-label">総データ数</span>
                <span id="totalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">表示中</span>
                <span id="displayCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">平均パワー</span>
                <span id="avgPower">0</span>
            </div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">順位<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(1)">ID<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(2)">プレイヤー名<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(3)">パワー<span class="sort-arrow">↓</span></th>
                        <th onclick="sortTable(4)">同盟<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(5)">T4キル<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(6)">T5キル<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(7)">総キルポイント<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(8)">死亡兵士<span class="sort-arrow"></span></th>
                        <th onclick="sortTable(9)">兵士パワー<span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="10" class="loading">データを読み込み中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination">
            <button id="prevBtn" onclick="changePage(-1)" disabled>← 前へ</button>
            <span id="pageInfo">1 / 1</span>
            <button id="nextBtn" onclick="changePage(1)" disabled>次へ →</button>
        </div>
    </div>

    <script>
        let gameData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 100;
        let sortColumn = 3; // デフォルトでパワーでソート
        let sortDirection = -1; // 降順

        // CSV読み込み処理
        async function loadData() {
            try {
                const response = await fetch('Master_Data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length === 0) {
                    throw new Error('CSVファイルが空です');
                }
                
                gameData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 10) {
                        gameData.push({
                            date: values[0],
                            id: values[1],
                            name: values[2],
                            power: parseNumber(values[3]),
                            alliance: values[4],
                            t4Kills: parseNumber(values[5]),
                            t5Kills: parseNumber(values[6]),
                            totalKillPoints: parseNumber(values[7]),
                            deadTroops: parseNumber(values[8]),
                            troopsPower: parseNumber(values[9])
                        });
                    }
                }
                
                // 同盟フィルターの選択肢を更新
                updateAllianceFilter();
                
                // データを表示
                filteredData = [...gameData];
                sortData();
                displayData();
                updateStats();
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="error-message">
                            データの読み込みに失敗しました: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // CSV行のパース（カンマを含む数値に対応）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(item => item.replace(/"/g, ''));
        }

        // 数値パース（カンマ区切りに対応）
        function parseNumber(str) {
            if (!str || str === '') return 0;
            return parseInt(str.replace(/,/g, '')) || 0;
        }

        // 数値フォーマット（カンマ区切り）
        function formatNumber(num) {
            return num.toLocaleString();
        }

        // データ表示処理
        function displayData() {
            const tableBody = document.getElementById('tableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="no-data">該当するデータがありません</td></tr>';
                updatePagination();
                return;
            }
            
            tableBody.innerHTML = '';
            
            pageData.forEach((player, index) => {
                const row = document.createElement('tr');
                const rank = startIndex + index + 1;
                
                row.innerHTML = `
                    <td>${rank}</td>
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${formatNumber(player.power)}</td>
                    <td><span class="alliance-badge">${player.alliance}</span></td>
                    <td>${formatNumber(player.t4Kills)}</td>
                    <td>${formatNumber(player.t5Kills)}</td>
                    <td>${formatNumber(player.totalKillPoints)}</td>
                    <td>${formatNumber(player.deadTroops)}</td>
                    <td>${formatNumber(player.troopsPower)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            updatePagination();
        }

        // 統計情報更新
        function updateStats() {
            const totalCount = gameData.length;
            const displayCount = filteredData.length;
            
            let avgPower = 0;
            if (filteredData.length > 0) {
                avgPower = filteredData.reduce((sum, player) => sum + player.power, 0) / filteredData.length;
            }
            
            document.getElementById('totalCount').textContent = formatNumber(totalCount);
            document.getElementById('displayCount').textContent = formatNumber(displayCount);
            document.getElementById('avgPower').textContent = formatNumber(Math.round(avgPower));
        }

        // 検索機能
        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...gameData];
            } else {
                filteredData = gameData.filter(player => 
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.id.toString().includes(searchTerm)
                );
            }
            
            // フィルターを適用
            applyFilters();
            
            currentPage = 1;
            sortData();
            displayData();
            updateStats();
        }

        // フィルター機能
        function filterData() {
            const powerFilter = parseInt(document.getElementById('powerFilter').value) || 0;
            const allianceFilter = document.getElementById('allianceFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = gameData.filter(player => {
                const matchesSearch = searchTerm === '' || 
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.id.toString().includes(searchTerm);
                const matchesPower = powerFilter === 0 || player.power >= powerFilter;
                const matchesAlliance = allianceFilter === '' || player.alliance === allianceFilter;
                
                return matchesSearch && matchesPower && matchesAlliance;
            });
            
            currentPage = 1;
            sortData();
            displayData();
            updateStats();
        }

        // フィルターの適用
        function applyFilters() {
            const powerFilter = parseInt(document.getElementById('powerFilter').value) || 0;
            const allianceFilter = document.getElementById('allianceFilter').value;
            
            if (powerFilter > 0) {
                filteredData = filteredData.filter(player => player.power >= powerFilter);
            }
            
            if (allianceFilter !== '') {
                filteredData = filteredData.filter(player => player.alliance === allianceFilter);
            }
        }

        // 同盟フィルター更新
        function updateAllianceFilter() {
            const allianceSelect = document.getElementById('allianceFilter');
            const alliances = [...new Set(gameData.map(player => player.alliance))].sort();
            
            // 既存のオプションをクリア（「全て」は残す）
            allianceSelect.innerHTML = '<option value="">全て</option>';
            
            alliances.forEach(alliance => {
                if (alliance && alliance.trim()) {
                    const option = document.createElement('option');
                    option.value = alliance;
                    option.textContent = alliance;
                    allianceSelect.appendChild(option);
                }
            });
        }

        // テーブルソート機能
        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection *= -1;
            } else {
                sortColumn = columnIndex;
                sortDirection = -1;
            }
            
            sortData();
            displayData();
            updateSortArrows();
        }

        // データソート
        function sortData() {
            const columnMap = {
                0: 'power', // 順位（パワーベース）
                1: 'id',
                2: 'name',
                3: 'power',
                4: 'alliance',
                5: 't4Kills',
                6: 't5Kills',
                7: 'totalKillPoints',
                8: 'deadTroops',
                9: 'troopsPower'
            };
            
            const sortKey = columnMap[sortColumn];
            
            filteredData.sort((a, b) => {
                let valueA = a[sortKey];
                let valueB = b[sortKey];
                
                // 文字列の場合
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    return sortDirection * valueA.localeCompare(valueB);
                }
                
                // 数値の場合
                return sortDirection * (valueA - valueB);
            });
        }

        // ソート矢印の更新
        function updateSortArrows() {
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '';
            });
            
            const currentArrow = document.querySelectorAll('.sort-arrow')[sortColumn];
            if (currentArrow) {
                currentArrow.textContent = sortDirection === 1 ? '↑' : '↓';
            }
        }

        // ページネーション
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayData();
            }
        }

        // ページネーション情報更新
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // ページサイズ更新
        function updatePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            displayData();
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>