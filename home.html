<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROK Kingdom Data - ホーム</title>
    <meta name="description" content="Rise of Kingdoms ゲームデータ統計・分析ツール - ホーム">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">

    <!-- Favicon設定 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏰</text></svg>">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANCSURBVFiFtZc9aBRBFMd/s7u5XCQhkVgIFoKFYKOFjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2N">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏰</text></svg>">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h1>🏰 ROK Kingdom Data</h1>
            <p>Rise of Kingdoms データ統計・分析ツール</p>
            <div style="margin: 30px 0;">
                <input type="password" id="passwordInput" placeholder="パスワードを入力してください" />
                <button id="loginButton" class="login-btn">ログイン</button>
                <div id="passwordError" style="color: #e74c3c; margin-top: 15px; display: none;">パスワードが正しくありません</div>
            </div>
        </div>
    </div>

    <!-- ホームコンテンツ（認証後に表示） -->
    <div id="homeContent" class="home-container" style="display: none;">
        <div class="container">
            <!-- ウェルカムセクション -->
            <div class="welcome-section">
                <h1>🏰 ROK Kingdom Data</h1>
                <p>Rise of Kingdoms のゲームデータを分析・可視化するための統合ツール</p>
            </div>

            <!-- 機能一覧 -->
            <div class="features-grid">
                <div class="feature-card">
                    <h3>📈 成長ランキング</h3>
                    <p>指定期間内での成長率や増加量をランキング形式で表示。プレイヤーの成長トレンドを把握できます。</p>
                    <a href="index.html#growth" class="feature-btn">成長を確認</a>
                </div>

                <div class="feature-card">
                    <h3>🏆 上位統計</h3>
                    <p>上位300人の統計データをグラフで可視化。王国全体の動向を把握し、戦略立案に活用できます。</p>
                    <a href="index.html#overall" class="feature-btn">統計を確認</a>
                </div>

                <div class="feature-card">
                    <h3>👤 個人分析</h3>
                    <p>特定プレイヤーの成長履歴をチャートで表示。個人の戦力推移やパフォーマンスを詳細に分析できます。</p>
                    <a href="index.html#individual" class="feature-btn">個人分析</a>
                </div>

                <div class="feature-card">
                    <h3>⚔️ KVKノルマ</h3>
                    <p>Power帯別の撃破ノルマや戦死ノルマを確認。KVK参加時の目標設定や戦略立案に役立ちます。</p>
                    <a href="index.html#kvk" class="feature-btn">ノルマ確認</a>
                </div>
            </div>

        </div>
    </div>

    <script>
        // パスワード設定（ソルト付きハッシュ）
        const CORRECT_PASSWORD_HASH = '4181190cdaee12e3c055f82abc95ac52a39852c7f0b28c1366e7baf7f99f9d08';
        const PASSWORD_SALT = 'ROK_DATA_SALT_2024';

        // ブルートフォース攻撃対策
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        let lockoutUntil = 0;

        // 強化されたハッシュ関数（ソルト付き）
        async function secureHash(text) {
            const encoder = new TextEncoder();
            const saltedText = PASSWORD_SALT + text + PASSWORD_SALT;
            const data = encoder.encode(saltedText);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // レート制限チェック
        function checkRateLimit() {
            const now = Date.now();
            if (lockoutUntil > now) {
                const remainingTime = Math.ceil((lockoutUntil - now) / 1000);
                throw new Error(`ログイン試行回数が上限を超えました。${remainingTime}秒後に再試行してください。`);
            }
            return true;
        }
        
        // DOM要素を取得
        const loginScreen = document.getElementById('loginScreen');
        const homeContent = document.getElementById('homeContent');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const passwordError = document.getElementById('passwordError');

        // ログイン機能（強化版）
        async function checkPassword() {
            const input = passwordInput.value.trim();

            try {
                // レート制限チェック
                checkRateLimit();

                // 入力されたパスワードをハッシュ化
                const inputHash = await secureHash(input);

                if (inputHash === CORRECT_PASSWORD_HASH) {
                    // 認証成功
                    loginAttempts = 0;
                    lockoutUntil = 0;
                    sessionStorage.setItem('authenticated', 'true');
                    sessionStorage.setItem('authTime', Date.now().toString());
                    showHomeContent();
                    loadQuickStats();
                } else {
                    // 認証失敗
                    loginAttempts++;

                    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        lockoutUntil = Date.now() + (30 * 1000); // 30秒ロックアウト
                        passwordError.textContent = 'ログイン試行回数が上限を超えました。30秒後に再試行してください。';
                    } else {
                        const remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
                        passwordError.textContent = `パスワードが正しくありません。残り試行回数: ${remainingAttempts}`;
                    }

                    passwordError.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        passwordInput.style.animation = '';
                    }, 500);
                }
            } catch (error) {
                console.error('認証エラー:', error);
                passwordError.textContent = error.message;
                passwordError.style.display = 'block';
            }
        }

        // ホームコンテンツを表示
        function showHomeContent() {
            loginScreen.style.display = 'none';
            homeContent.style.display = 'block';
        }

        // 簡易統計を読み込み（エラーハンドリング強化）
        function loadQuickStats() {
            // ホーム画面では統計表示要素がないため、エラーを回避
            const totalElement = document.getElementById('totalRecordsHome');
            const updateElement = document.getElementById('lastUpdateHome');

            if (!totalElement || !updateElement) {
                // 統計表示要素がない場合はスキップ
                return;
            }

            fetch('Master_Data.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n').filter(line => line.trim());
                    totalElement.textContent = (lines.length - 1).toLocaleString() + '件';

                    const now = new Date();
                    updateElement.textContent = now.toLocaleDateString('ja-JP');
                })
                .catch(error => {
                    console.log('統計データの読み込みに失敗しました:', error);
                });
        }

        // イベントリスナー設定
        loginButton.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                checkPassword();
            }
        });

        // セッション有効性チェック（24時間）
        function isSessionValid() {
            const authenticated = sessionStorage.getItem('authenticated');
            const authTime = sessionStorage.getItem('authTime');

            if (!authenticated || !authTime) return false;

            const now = Date.now();
            const sessionAge = now - parseInt(authTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24時間

            return sessionAge < maxAge;
        }

        // セッションクリア
        function clearSession() {
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('authTime');
        }

        // 認証済みかチェック（強化版）
        window.addEventListener('DOMContentLoaded', () => {
            if (isSessionValid()) {
                showHomeContent();
                loadQuickStats();
            } else {
                clearSession();
                passwordInput.focus();
            }
        });
    </script>
</body>
</html>