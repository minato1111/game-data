<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROK Kingdom Data - ãƒ›ãƒ¼ãƒ </title>
    <meta name="description" content="Rise of Kingdoms ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆãƒ»åˆ†æãƒ„ãƒ¼ãƒ« - ãƒ›ãƒ¼ãƒ ">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">

    <!-- Faviconè¨­å®š -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ°</text></svg>">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANCSURBVFiFtZc9aBRBFMd/s7u5XCQhkVgIFoKFYKOFjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2N">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ°</text></svg>">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h1>ğŸ° ROK Kingdom Data</h1>
            <p>Rise of Kingdoms ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆãƒ»åˆ†æãƒ„ãƒ¼ãƒ«</p>
            <div style="margin: 30px 0;">
                <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
                <button id="loginButton" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="passwordError" style="color: #e74c3c; margin-top: 15px; display: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
    <div id="homeContent" class="home-container" style="display: none;">
        <div class="container">
            <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="welcome-section">
                <h1>ğŸ° ROK Kingdom Data</h1>
                <p>Rise of Kingdoms ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æãƒ»å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®çµ±åˆãƒ„ãƒ¼ãƒ«</p>
            </div>

            <!-- æ©Ÿèƒ½ä¸€è¦§ -->
            <div class="features-grid">
                <div class="feature-card">
                    <h3>ğŸ“ˆ æˆé•·ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <p>æŒ‡å®šæœŸé–“å†…ã§ã®æˆé•·ç‡ã‚„å¢—åŠ é‡ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼ã§è¡¨ç¤ºã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚</p>
                    <a href="index.html#growth" class="feature-btn">æˆé•·ã‚’ç¢ºèª</a>
                </div>

                <div class="feature-card">
                    <h3>ğŸ† ä¸Šä½çµ±è¨ˆ</h3>
                    <p>ä¸Šä½300äººã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã€‚ç‹å›½å…¨ä½“ã®å‹•å‘ã‚’æŠŠæ¡ã—ã€æˆ¦ç•¥ç«‹æ¡ˆã«æ´»ç”¨ã§ãã¾ã™ã€‚</p>
                    <a href="index.html#overall" class="feature-btn">çµ±è¨ˆã‚’ç¢ºèª</a>
                </div>

                <div class="feature-card">
                    <h3>ğŸ‘¤ å€‹äººåˆ†æ</h3>
                    <p>ç‰¹å®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆé•·å±¥æ­´ã‚’ãƒãƒ£ãƒ¼ãƒˆã§è¡¨ç¤ºã€‚å€‹äººã®æˆ¦åŠ›æ¨ç§»ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è©³ç´°ã«åˆ†æã§ãã¾ã™ã€‚</p>
                    <a href="index.html#individual" class="feature-btn">å€‹äººåˆ†æ</a>
                </div>

                <div class="feature-card">
                    <h3>âš”ï¸ KVKãƒãƒ«ãƒ</h3>
                    <p>Powerå¸¯åˆ¥ã®æ’ƒç ´ãƒãƒ«ãƒã‚„æˆ¦æ­»ãƒãƒ«ãƒã‚’ç¢ºèªã€‚KVKå‚åŠ æ™‚ã®ç›®æ¨™è¨­å®šã‚„æˆ¦ç•¥ç«‹æ¡ˆã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
                    <a href="index.html#kvk" class="feature-btn">ãƒãƒ«ãƒç¢ºèª</a>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆã‚½ãƒ«ãƒˆä»˜ããƒãƒƒã‚·ãƒ¥ï¼‰
        const CORRECT_PASSWORD_HASH = '4181190cdaee12e3c055f82abc95ac52a39852c7f0b28c1366e7baf7f99f9d08';
        const PASSWORD_SALT = 'ROK_DATA_SALT_2024';

        // ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        let lockoutUntil = 0;

        // å¼·åŒ–ã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆã‚½ãƒ«ãƒˆä»˜ãï¼‰
        async function secureHash(text) {
            const encoder = new TextEncoder();
            const saltedText = PASSWORD_SALT + text + PASSWORD_SALT;
            const data = encoder.encode(saltedText);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
        function checkRateLimit() {
            const now = Date.now();
            if (lockoutUntil > now) {
                const remainingTime = Math.ceil((lockoutUntil - now) / 1000);
                throw new Error(`ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¾ã—ãŸã€‚${remainingTime}ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
            }
            return true;
        }
        
        // DOMè¦ç´ ã‚’å–å¾—
        const loginScreen = document.getElementById('loginScreen');
        const homeContent = document.getElementById('homeContent');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const passwordError = document.getElementById('passwordError');

        // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        async function checkPassword() {
            const input = passwordInput.value.trim();

            try {
                // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
                checkRateLimit();

                // å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
                const inputHash = await secureHash(input);

                if (inputHash === CORRECT_PASSWORD_HASH) {
                    // èªè¨¼æˆåŠŸ
                    loginAttempts = 0;
                    lockoutUntil = 0;
                    sessionStorage.setItem('authenticated', 'true');
                    sessionStorage.setItem('authTime', Date.now().toString());
                    showHomeContent();
                    loadQuickStats();
                } else {
                    // èªè¨¼å¤±æ•—
                    loginAttempts++;

                    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        lockoutUntil = Date.now() + (30 * 1000); // 30ç§’ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                        passwordError.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¾ã—ãŸã€‚30ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        const remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
                        passwordError.textContent = `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æ®‹ã‚Šè©¦è¡Œå›æ•°: ${remainingAttempts}`;
                    }

                    passwordError.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        passwordInput.style.animation = '';
                    }, 500);
                }
            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                passwordError.textContent = error.message;
                passwordError.style.display = 'block';
            }
        }

        // ãƒ›ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        function showHomeContent() {
            loginScreen.style.display = 'none';
            homeContent.style.display = 'block';
        }

        // ç°¡æ˜“çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        function loadQuickStats() {
            // ãƒ›ãƒ¼ãƒ ç”»é¢ã§ã¯çµ±è¨ˆè¡¨ç¤ºè¦ç´ ãŒãªã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
            const totalElement = document.getElementById('totalRecordsHome');
            const updateElement = document.getElementById('lastUpdateHome');

            if (!totalElement || !updateElement) {
                // çµ±è¨ˆè¡¨ç¤ºè¦ç´ ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                return;
            }

            fetch('Master_Data.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n').filter(line => line.trim());
                    totalElement.textContent = (lines.length - 1).toLocaleString() + 'ä»¶';

                    const now = new Date();
                    updateElement.textContent = now.toLocaleDateString('ja-JP');
                })
                .catch(error => {
                    console.log('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        loginButton.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                checkPassword();
            }
        });

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆ24æ™‚é–“ï¼‰
        function isSessionValid() {
            const authenticated = sessionStorage.getItem('authenticated');
            const authTime = sessionStorage.getItem('authTime');

            if (!authenticated || !authTime) return false;

            const now = Date.now();
            const sessionAge = now - parseInt(authTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24æ™‚é–“

            return sessionAge < maxAge;
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
        function clearSession() {
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('authTime');
        }

        // èªè¨¼æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            if (isSessionValid()) {
                showHomeContent();
                loadQuickStats();
            } else {
                clearSession();
                passwordInput.focus();
            }
        });
    </script>
</body>
</html>